<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Transaction Analysis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f6ff; padding:20px; }
    .card { background: white; border-radius:10px; padding:18px; box-shadow: 0 4px 20px rgba(20,20,60,0.06); max-width:900px; margin:20px auto; }
    .feature-row { display:flex; align-items:center; gap:16px; margin-bottom:14px; }
    .feature-name { width:160px; font-weight:600; }
    .bar-wrap { flex:1; background:#eef2ff; border-radius:8px; height:18px; position:relative; }
    .bar { height:100%; border-radius:8px; background:linear-gradient(90deg,#FF4D4F,#FF9A61); width:0%; transition: width 700ms ease; }
    .percent { width:60px; text-align:right; font-weight:600; color:#333; }
    .buttons { display:flex; gap:12px; margin-top:20px; }
    button { padding:10px 16px; border-radius:8px; border:0; cursor:pointer; font-weight:700; }
    .approve { background:#5b8cff; color: white; }
    .flag { background:#ff4d4f; color: white; }
    .review { background:#e6e9ef; color: #222; }
    .top-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .txn-details { font-size:14px; color:#334155; }
    .notice { margin-top:12px; font-size:13px; color:#555; }
    canvas { margin-top:20px; }
    form { margin-bottom:20px; display:flex; gap:10px; justify-content:center; }
    input[type=text] { padding:8px; border-radius:6px; border:1px solid #ccc; flex:1; }
    button[type=submit] { padding:8px 16px; border-radius:6px; border:none; background:#5b8cff; color:white; cursor:pointer; font-weight:600; }
  </style>
</head>
<body>

<h1 style="text-align:center;">Transaction Analysis</h1>

<!-- Transaction Search Form -->
<form action="/analyze_transaction" method="post">
    <input type="text" name="transaction_id" placeholder="Enter Transaction ID" required>
    <button type="submit">Submit</button>
</form>

{% if error %}
<p style="color:red; text-align:center">{{ error }}</p>
{% endif %}

{% if transaction %}
<div class="card">
  <div class="top-row">
    <h3>Feature Importance</h3>
    <div class="txn-details" id="txn-summary">
      From {{ transaction.Sender }} ‚Üí {{ transaction.Receiver }} ‚Ä¢ ‚Çπ{{ transaction.Amount }}
    </div>
  </div>

  <div id="features"></div>

  <div style="display:flex; gap:12px; align-items:center; margin-top:14px;">
    <div id="fraud-prob" style="font-weight:700"></div>
    <div id="avg-amount" style="color:#666"></div>
  </div>

  <div class="buttons">
    <button class="approve" id="btn-approve">Approve Transaction</button>
    <button class="flag" id="btn-flag">Flag as Fraudulent</button>
    <button class="review" id="btn-review">Request Review</button>
  </div>

  <div class="notice" id="action-status"></div>
</div>

<div class="card">
  <h2>Transaction Details</h2>
  <p><b>ID:</b> {{ transaction.TransactionID }}</p>
  <p><b>Date:</b> {{ transaction.Date }}</p>
  <p><b>Type:</b> {{ transaction.Type }}</p>
  <p><b>Location:</b> {{ transaction.Location }}</p>
  <p><b>Device:</b> {{ transaction.Device }}</p>
  <p><b>Risk Score:</b> {{ transaction.RiskScore }}%</p>
</div>

<div class="card">
  <h3>All Transaction Type Breakdown</h3>
  <canvas id="typeBreakdownChart"></canvas>
</div>

<div class="card">
  <h3>Transaction Risk Distribution</h3>
  <canvas id="riskPieChart"></canvas>
</div>

<div class="card">
  <h3>Behavior Profile Radar Chart</h3>
  <canvas id="behaviorRadarChart"></canvas>
</div>

<!-- Pass data as JSON to JS -->
<script type="application/json" id="txnData">
{
  "transaction": {
    "sender_id": "{{ transaction.Sender }}",
    "receiver_id": "{{ transaction.Receiver }}",
    "amount": {{ transaction.Amount | default('0') | replace(',', '') }},
    "device_id": "{{ transaction.Device }}",
    "timestamp": "{{ transaction.Date }}",
    "location": "{{ transaction.Location }}"
  },
  "chartLabels": {{ chart_labels | tojson | default('[]') | safe }},
  "chartData": {{ chart_data | tojson | default('[]') | safe }},
  "riskLabels": {{ risk_labels | tojson | default('[]') | safe }},
  "riskData": {{ risk_data | tojson | default('[]') | safe }},
  "behaviorLabels": {{ behavior_labels | tojson | default('[]') | safe }},
  "behaviorData": {{ behavior_data | tojson | default('[]') | safe }}
}
</script>

<script>
const FEATURE_KEYS = [
  { key: "unusual_amount", label: "Unusual Amount" },
  { key: "unknown_device", label: "Unknown Device" },
  { key: "time_anomaly", label: "Time Anomaly" },
  { key: "location_consistency", label: "Location Consistency" }
];

function createFeatureRows(container) {
  container.innerHTML = "";
  FEATURE_KEYS.forEach(f => {
    const row = document.createElement('div');
    row.className = 'feature-row';
    row.innerHTML = `
      <div class="feature-name">${f.label}</div>
      <div class="bar-wrap"><div class="bar" id="bar-${f.key}"></div></div>
      <div class="percent" id="pct-${f.key}">0%</div>
    `;
    container.appendChild(row);
  });
}

async function evaluateTransaction(txn) {
  try {
    const res = await fetch('/evaluate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(txn)
    });
    if (!res.ok) {
      const txt = await res.text();
      document.getElementById('action-status').innerText = "Evaluation failed: " + txt;
      return null;
    }
    return await res.json();
  } catch (err) {
    document.getElementById('action-status').innerText = "Error: " + err.message;
    return null;
  }
}

function animateBars(features) {
  FEATURE_KEYS.forEach(f => {
    const val = features[f.key] ?? 0;
    const bar = document.getElementById('bar-' + f.key);
    const pct = document.getElementById('pct-' + f.key);
    setTimeout(() => { bar.style.width = val + "%"; }, 50);
    pct.innerText = val + "%";
  });
  if (features.fraud_probability !== undefined) {
    document.getElementById('fraud-prob').innerText = "Fraud score: " + Math.round(features.fraud_probability * 100) + "%";
  }
  if (features.avg_amount !== undefined) {
    document.getElementById('avg-amount').innerText = "(sender avg: ‚Çπ" + Math.round(features.avg_amount) + ")";
  }
}
async function sendDecision(decision, txn) {
  try {
    const resp = await fetch('/decision', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ decision, txn })
    });

    const result = await resp.json();

    if (result.status === "success") {
      document.getElementById('action-status').innerText =
        `‚úÖ ${result.message}`;
    } else {
      document.getElementById('action-status').innerText =
        `‚ö†Ô∏è ${result.message}`;
    }

  } catch (error) {
    console.error('Error:', error);
    document.getElementById('action-status').innerText =
      '‚ùå Error saving decision.';
  }
}



document.addEventListener('DOMContentLoaded', async () => {
  const dataEl = document.getElementById('txnData');
  if (!dataEl) return;

  const data = JSON.parse(dataEl.textContent);
  const txn = data.transaction;

  createFeatureRows(document.getElementById('features'));
  const result = await evaluateTransaction(txn);
  if (result && result.features) animateBars(result.features);

  document.getElementById('btn-approve')?.addEventListener('click', () => sendDecision('approve', txn));
  document.getElementById('btn-flag')?.addEventListener('click', () => sendDecision('flag', txn));
  document.getElementById('btn-review')?.addEventListener('click', () => sendDecision('review', txn));

  const ctxBar = document.getElementById('typeBreakdownChart')?.getContext('2d');
  if (ctxBar) new Chart(ctxBar, {
    type:'bar',
    data:{labels: data.chartLabels, datasets:[{label:'Number of Transactions', data: data.chartData, backgroundColor:'rgba(54,162,235,0.5)', borderColor:'rgba(54,162,235,1)', borderWidth:1}]},
    options:{responsive:true, scales:{y:{beginAtZero:true}}}
  });

  const ctxPie = document.getElementById('riskPieChart')?.getContext('2d');
  if (ctxPie) new Chart(ctxPie, {
    type:'pie',
    data:{labels: data.riskLabels, datasets:[{label:'Transaction Risk', data: data.riskData, backgroundColor:['rgba(75,192,192,0.5)','rgba(255,206,86,0.5)','rgba(255,99,132,0.5)'], borderColor:['rgba(75,192,192,1)','rgba(255,206,86,1)','rgba(255,99,132,1)'], borderWidth:1}]},
    options:{responsive:true}
  });

  const ctxRadar = document.getElementById('behaviorRadarChart')?.getContext('2d');
  if (ctxRadar) new Chart(ctxRadar, {
    type:'radar',
    data:{labels: data.behaviorLabels, datasets:[{label:'Transaction Behavior Profile', data: data.behaviorData, backgroundColor:'rgba(54,162,235,0.2)', borderColor:'rgba(54,162,235,1)', pointBackgroundColor:'rgba(54,162,235,1)'}]},
    options:{responsive:true, scales:{r:{min:0,max:1,ticks:{stepSize:0.2}}}}
  });

});
</script>
{% endif %}

</body>
</html>



//index html 
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>UPI Fraud Detection Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <form action="/analysis" method="get">
  <button type="submit"><b>TransationAnalysis</b></button>
</form>
 <form action="/qranalysis" method="get">
  <button type="submit"><b>QRAnalysis</b></button>
</form>
  <h1>Recent Transactions</h1>

  <div class="chart-container">
    <canvas id="transactionTypeChart"></canvas>
  </div>
  
  <input type="text" id="search" placeholder="Search transactions...">
  <select id="filter">
    <option value="All">All Risk Levels</option>
    <option value="High Risk">High Risk</option>
    <option value="Low Risk">Low Risk</option>
  </select>

  <table id="txnTable">
    <thead>
      <tr>
        <th>Transaction ID</th>
        <th>Date</th>
        <th>Amount</th>
        <th>Type</th>
        <th>Parties</th>
        <th>Risk Score</th>
        <th>Status</th>
        <th>Anomalies</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script src="{{ url_for('static', filename='script.js') }}"></script>

</body>
</html>
//qr upload html
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QR Code Fraud Detection</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f8;
}
.container{
  width:700px;
  margin:50px auto;
  background:white;
  padding:25px;
  border-radius:15px;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
}
h1{color:#0078d4;}

.info-box{
  background:#f9f9f9;
  border-left:5px solid #0078d4;
  padding:10px;
  margin-bottom:15px;
}

.upload-box{
  padding:20px;
  border:2px dashed #0078d4;
  background:#f8fbff;
  border-radius:10px;
}

button{
  background:#0078d4;
  color:white;
  border:none;
  padding:10px 20px;
  border-radius:6px;
  cursor:pointer;
}

.result{
  margin-top:20px;
  padding:15px;
  background:#eef6ff;
  border-radius:8px;
  display:none;
}

.success{color:green;font-weight:bold;}
.error{color:red;font-weight:bold;}
</style>
</head>

<body>

<div class="container">

<h1>QR Code Fraud Detection</h1>

<div class="info-box">
  <p>{{ dataset_status }}</p>
  <p><b>Total Records:</b> {{ dataset_rows }}</p>
  <p>{{ model_status }}</p>
  <p><b>Model Accuracy:</b> {{ model_accuracy }}%</p>
</div>

<div class="upload-box">
  <h3>üì∏ Upload QR Image</h3>

  <form id="uploadForm">
    <input type="file" id="qrFile" required>
    <br><br>
    <button type="submit">Analyze QR</button>
  </form>
</div>

<div class="result" id="resultBox"></div>

</div>

<script>

const form = document.getElementById("uploadForm");
const resultBox = document.getElementById("resultBox");

form.addEventListener("submit", async function(e){

    e.preventDefault();

    const file = document.getElementById("qrFile").files[0];

    if(!file){
        alert("Select QR Image First!");
        return;
    }

    let fd = new FormData();
    fd.append("file", file);

    // ‚úÖ STEP 1 ‚Äì SCANNING
    resultBox.style.display="block";
    resultBox.innerHTML="<p>‚è≥ Scanning QR...</p>";

    try{

        const res = await fetch("/upload_qr", {
            method:"POST",
            body: fd
        });

        const data = await res.json();

        if(data.error){
            resultBox.innerHTML=`<p class="error">‚ùå ${data.error}</p>`;
            return;
        }

        // ‚úÖ STEP 2 ‚Äì QR VERIFIED
        resultBox.innerHTML = `
            <p class="success">‚úÖ QR VALIDATED</p>
            <p><b>FRAUD:</b> ${data.fraud}</p>
            <p><b>QR DATA:</b> ${data.qr_data}</p>
            <p>‚è≥ Loading Transaction Details...</p>
        `;

        // ‚úÖ STEP 3 ‚Äì 2 SECOND WAIT THEN SHOW DETAILS
        setTimeout(()=>{

            const a = data.attributes || {};   // ‚úÖ SAFE HANDLING

            resultBox.innerHTML += `
            <hr>

            <h3>üìã Transaction Details</h3>

            <ul>
              <li><b>Merchant:</b> ${a.merchant || "Not Found"}</li>
              <li><b>UPI:</b> ${a.payee_vpa || "Not Found"}</li>
              <li><b>Location:</b> ${a.location || "Not Found"}</li>
              <li><b>Category:</b> ${a.category || "Not Found"}</li>
              <li><b>Customer:</b> ${a.customer || "Not Found"}</li>
              <li><b>Phone:</b> ${a.phone || "Not Found"}</li>
              <li><b>Amount:</b> ‚Çπ${a.amount || "Not Found"}</li>
              <li><b>Status:</b> ${a.payment_status || "Not Found"}</li>
              <li><b>Date:</b> ${a.date_time || "Not Found"}</li>
            </ul>
            `;

        },2000);

    }
    catch(err){
        resultBox.innerHTML=`<p class="error">‚ùå ${err}</p>`;
    }

});

</script>

</body>
</html>




